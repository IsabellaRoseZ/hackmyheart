<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hack My Heart CTF</title>
  <link rel="stylesheet" href="assets/style.css?v=6"/>
</head>
<body>
  <header class="wrap header-bar">
    <div class="header-left">
      <img src="assets/logo.png" alt="Hack My Heart CTF logo" class="logo"/>

      <div class="title-block">
        <h1 class="ombre-title">Hack My Heart CTF</h1>
        <p class="sub">
          40 Valentine’s-themed challenges • Jeopardy-style • submit flags via Google Form • check scoreboard for status
        </p>
      </div>
    </div>

    <div class="links">
      <a class="btn" href="YOUR_GOOGLE_FORM_LINK" target="_blank" rel="noopener">Submit Flags</a>
      <a class="btn" href="scoreboard.html">Scoreboard</a>
      <a class="btn" href="rules.html">Rules</a>
    </div>
  </header>

  <main class="wrap">
    <div class="controls">
      <input id="search" placeholder="Search challenges (e.g., crypto, pcap, web)"/>
      <select id="cat">
        <option value="">All categories</option>
      </select>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <script>
    const grid = document.getElementById("grid");
    const search = document.getElementById("search");
    const cat = document.getElementById("cat");
    const FORM_LINK = "YOUR_GOOGLE_FORM_LINK";

    let all = [];
    let openId = null; // only one open panel at a time

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function render() {
      const q = search.value.toLowerCase().trim();
      const c = cat.value;

      const filtered = all.filter(x => {
        const hay = (x.title + " " + x.category + " " + (x.tags||[]).join(" ")).toLowerCase();
        return (!q || hay.includes(q)) && (!c || x.category === c);
      });

      grid.innerHTML = filtered.map(x => {
        const isOpen = openId === x.id;

        return `
          <article class="card" data-id="${escapeHtml(x.id)}">
            <div class="row">
              <div>
                <div class="title">${escapeHtml(x.title)}</div>
                <div class="meta">${escapeHtml(x.category)} • ${escapeHtml(x.points)} pts • ID: <code>${escapeHtml(x.id)}</code></div>
              </div>
              <span class="pill">${escapeHtml(x.difficulty)}</span>
            </div>

            <p class="desc">${escapeHtml(x.prompt || "")}</p>

            <button class="link start-btn" data-id="${escapeHtml(x.id)}">
              ${isOpen ? "Close" : "Start Challenge"}
            </button>
              <a class="link" href="${FORM_LINK}" target="_blank" rel="noopener">Submit Flag</a>
            </div>

            <div class="briefing-panel ${isOpen ? "open" : ""}" id="panel-${escapeHtml(x.id)}">
              ${isOpen ? briefingHtml(x) : ""}
            </div>
          </article>
        `;
      }).join("");

      // Wire up Start Challenge buttons
      document.querySelectorAll(".start-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          openId = (openId === id) ? null : id;
          render();
          // scroll the opened panel into view slightly (nice UX)
          if (openId) {
            const card = document.querySelector(`.card[data-id="${CSS.escape(openId)}"]`);
            const panel = card?.querySelector(".briefing-panel");
            panel?.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        });
      });
    }

    function briefingHtml(x) {
      const parts = [];

      // Briefing text (use briefing if present, else prompt)
      const text = (x.briefing || x.prompt || "").trim();
      if (text) {
        parts.push(`
          <div class="briefing-text">
            ${escapeHtml(text).replaceAll("\n", "<br/>")}
          </div>
        `);
      }

      // Downloads: support downloads[] or download string
      const links = [];

      if (Array.isArray(x.downloads) && x.downloads.length) {
        x.downloads.forEach(d => {
          if (d && d.url) {
            links.push(`<a class="briefing-link" href="${escapeHtml(d.url)}" target="_blank" rel="noopener">⬇ ${escapeHtml(d.label || "Download")}</a>`);
          }
        });
      } else if (x.download) {
        links.push(`<a class="briefing-link" href="${escapeHtml(x.download)}" target="_blank" rel="noopener">⬇ Download files</a>`);
      }

      if (x.url) {
        links.push(`<a class="briefing-link" href="${escapeHtml(x.url)}" target="_blank" rel="noopener">↗ Open resource</a>`);
      }

      if (links.length) {
        parts.push(`<div class="briefing-links">${links.join("")}</div>`);
      } else {
        parts.push(`<div class="briefing-muted">No downloads needed — solve from the briefing.</div>`);
      }

      // Hint (optional)
      if (x.hint) {
        parts.push(`
          <details class="hint">
            <summary>Hint</summary>
            <p>${escapeHtml(x.hint)}</p>
          </details>
        `);
      }

      // Quick copy helper for Challenge ID
      parts.push(`
        <div class="briefing-tools">
          <button class="copy-btn" onclick="navigator.clipboard.writeText('${escapeHtml(x.id)}')">Copy Challenge ID</button>
          <a class="copy-btn ghost" href="${FORM_LINK}" target="_blank" rel="noopener">Submit Flag</a>
        </div>
      `);

      return parts.join("");
    }

    fetch("challenges.json")
      .then(r => r.json())
      .then(data => {
        all = data;
        const cats = [...new Set(all.map(x => x.category))].sort();
        cats.forEach(c => {
          const o = document.createElement("option");
          o.value = c; o.textContent = c;
          cat.appendChild(o);
        });
        render();
      });

    search.addEventListener("input", () => { openId = null; render(); });
    cat.addEventListener("change", () => { openId = null; render(); });
  </script>
</body>
</html>
