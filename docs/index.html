<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hack My Heart CTF</title>
  <link rel="stylesheet" href="assets/style.css?v=7"/>
</head>
<body>
  <header class="wrap header-bar">
    <div class="header-left">
      <img src="assets/logo.png" alt="Hack My Heart CTF logo" class="logo"/>

      <div class="title-block">
        <h1 class="ombre-title">Hack My Heart CTF</h1>
        <p class="sub">
          42 Valentine’s-themed challenges • Jeopardy-style • submit flags via Google Form • check scoreboard for status
        </p>
      </div>
    </div>

    <div class="links">
      <a class="btn" href="https://docs.google.com/forms/d/e/1FAIpQLSdJnzlEjj_6VuNpsLuj85gKa5NOuNpdw7XB567A7jFfqqm54Q/viewform" target="_blank" rel="noopener">Submit Flags</a>
      <a class="btn" href="scoreboard.html">Scoreboard</a>
      <a class="btn" href="rules.html">Rules</a>
    </div>
  </header>

  <main class="wrap">
    <div class="controls">
      <input id="search" placeholder="Search challenges"/>
      <select id="cat">
        <option value="">All categories</option>
      </select>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <script>
    const grid = document.getElementById("grid");
    const search = document.getElementById("search");
    const cat = document.getElementById("cat");
    const FORM_LINK = "https://docs.google.com/forms/d/e/1FAIpQLSdJnzlEjj_6VuNpsLuj85gKa5NOuNpdw7XB567A7jFfqqm54Q/viewform";

    let all = [];
    let openId = null; // only one open panel at a time

    // Track completed challenges
    const COMPLETED_KEY = "hmh_completed";
    let completed = new Set(JSON.parse(localStorage.getItem(COMPLETED_KEY) || "[]"));
    function saveCompleted() {
      localStorage.setItem(COMPLETED_KEY, JSON.stringify([...completed]));
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeText(s) {
      return s
        .split("\n")
        .map(line => line.trimStart())
        .join("\n");
    }

    function render() {
      const q = search.value.toLowerCase().trim();
      const c = cat.value;

      const filtered = all.filter(x => {
        const hay = (x.title + " " + x.category + " " + (x.tags||[]).join(" ")).toLowerCase();
        return (!q || hay.includes(q)) && (!c || x.category === c);
      });

      grid.innerHTML = filtered.map(x => {
        const isOpen = openId === x.id;
        const isOtherWhenOpen = !!openId && !isOpen;

        return `
          <article class="card ${isOpen ? "active" : ""} ${isOtherWhenOpen ? "collapsed" : ""} ${completed.has(x.id) ? "completed" : ""}" data-id="${escapeHtml(x.id)}">
            <div class="row">
              <div>
                <div class="title">${escapeHtml(x.title)}</div>
                <div class="meta">${escapeHtml(x.category)} • ${escapeHtml(x.points)} pts • ID: <code>${escapeHtml(x.id)}</code></div>
              </div>
              <span class="pill">${escapeHtml(x.difficulty)}</span>
            </div>

            <button class="link start-btn" data-id="${escapeHtml(x.id)}" ${isOtherWhenOpen ? "disabled" : ""}>
              ${isOpen ? "Close Challenge" : "Start Challenge"}
            </button>

            <div class="briefing-panel ${isOpen ? "open" : ""}" id="panel-${escapeHtml(x.id)}">
              ${isOpen ? briefingHtml(x) : ""}
            </div>
          </article>
        `;
      }).join("");

      // Wire up Start/Close buttons
      document.querySelectorAll(".start-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation(); // IMPORTANT: prevents immediate close
          const id = btn.getAttribute("data-id");
          openId = (openId === id) ? null : id;
          render();

          if (openId) {
            const card = document.querySelector(`.card[data-id="${CSS.escape(openId)}"]`);
            const panel = card?.querySelector(".briefing-panel");
            panel?.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        });
      });
    }

    // Close open challenge when clicking anywhere outside the open card
    document.addEventListener("click", (e) => {
      if (!openId) return;
      const activeCard = document.querySelector(`.card[data-id="${CSS.escape(openId)}"]`);
      if (!activeCard) return;
      if (!activeCard.contains(e.target)) {
        openId = null;
        render();
      }
    }, true); // capture phase

    function briefingHtml(x) {
      const parts = [];

      const rawText = (x.briefing || x.prompt || "").trim();
      const text = normalizeText(rawText);
      
      if (text) {
        parts.push(`
          <div class="briefing-text">${escapeHtml(text).replaceAll("\n", "<br/>")}</div>
        `);
      }

      if (x.preview_image) {
        parts.push(`
          <div class="briefing-preview">
            <img src="${escapeHtml(x.preview_image)}" alt="Challenge image" class="briefing-img"/>
          </div>
        `);
      }

      const links = [];
      if (Array.isArray(x.downloads) && x.downloads.length) {
        x.downloads.forEach(d => {
          if (d && d.url) {
            links.push(`<a class="briefing-link" href="${escapeHtml(d.url)}" target="_blank" rel="noopener">⬇ ${escapeHtml(d.label || "Download")}</a>`);
          }
        });
      } else if (x.download) {
        links.push(`<a class="briefing-link" href="${escapeHtml(x.download)}" target="_blank" rel="noopener">⬇ Download files</a>`);
      }

      if (x.url) {
        links.push(`<a class="briefing-link" href="${escapeHtml(x.url)}" target="_blank" rel="noopener">↗ Open resource</a>`);
      }

      if (links.length) {
        parts.push(`<div class="briefing-links">${links.join("")}</div>`);
      } else {
        parts.push(`<div class="briefing-muted">No downloads needed — solve from the briefing.</div>`);
      }

      if (x.hint) {
        parts.push(`
          <details class="hint">
            <summary>Hint</summary>
            <p>${escapeHtml(x.hint)}</p>
          </details>
        `);
      }

      parts.push(`
        <button
          class="link complete-btn ${completed.has(x.id) ? "done" : ""}"
          onclick="event.stopPropagation(); toggleComplete('${escapeHtml(x.id)}')">
          ${completed.has(x.id) ? "Mark Incomplete" : "Mark Complete"}
        </button>
      `);

      parts.push(`
        <div class="briefing-tools">
          <button class="copy-btn" onclick="navigator.clipboard.writeText('${escapeHtml(x.id)}')">Copy Challenge ID</button>
          <a class="copy-btn ghost" href="${FORM_LINK}" target="_blank" rel="noopener">Submit Flag</a>
        </div>
      `);

      return parts.join("");
    }

    // Toggle completed state
    function toggleComplete(id) {
      if (completed.has(id)) {
        completed.delete(id);
      } else {
        completed.add(id);
      }
      saveCompleted();
      render();
    }

    fetch("challenges.json")
      .then(r => r.json())
      .then(data => {
        all = data;
        const cats = [...new Set(all.map(x => x.category))].sort();
        cats.forEach(c => {
          const o = document.createElement("option");
          o.value = c; o.textContent = c;
          cat.appendChild(o);
        });
        render();
      });

    search.addEventListener("input", () => { openId = null; render(); });
    cat.addEventListener("change", () => { openId = null; render(); });

  </script>
</body>
</html>
