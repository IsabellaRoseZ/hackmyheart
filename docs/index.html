<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hack My Heart CTF</title>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <header class="wrap header-bar">
    <div class="header-left">
      <img src="assets/logo.png" alt="Hack My Heart CTF logo" class="logo"/>

      <div class="title-block">
        <h1 class="ombre-title">Hack My Heart CTF</h1>
        <p class="sub">
          40 Valentine’s-themed challenges • Jeopardy-style • submit flags via Google Form • check scoreboard for status
        </p>
      </div>
    </div>

    <div class="links">
      <a class="btn" href="YOUR_GOOGLE_FORM_LINK" target="_blank" rel="noopener">Submit Flags</a>
      <a class="btn" href="scoreboard.html">Scoreboard</a>
      <a class="btn" href="rules.html">Rules</a>
    </div>
  </header>

  <main class="wrap">
    <div class="controls">
      <input id="search" placeholder="Search challenges (e.g., crypto, pcap, web)"/>
      <select id="cat">
        <option value="">All categories</option>
      </select>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-x" id="modalClose" aria-label="Close">✕</button>

      <div class="modal-top">
        <div>
          <div id="modalTitle" class="modal-title"></div>
          <div id="modalMeta" class="modal-meta"></div>
        </div>
        <span id="modalPill" class="pill"></span>
      </div>

      <div id="modalBrief" class="modal-brief"></div>

      <div id="modalLinks" class="modal-links"></div>

      <div class="modal-actions">
        <a class="btn" id="modalSubmit" href="YOUR_GOOGLE_FORM_LINK" target="_blank" rel="noopener">Submit Flag</a>
        <button class="btn ghost" id="modalDone">Back to Challenges</button>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const search = document.getElementById("search");
    const cat = document.getElementById("cat");

    // Modal elements
    const backdrop = document.getElementById("modalBackdrop");
    const modalClose = document.getElementById("modalClose");
    const modalDone = document.getElementById("modalDone");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const modalPill = document.getElementById("modalPill");
    const modalBrief = document.getElementById("modalBrief");
    const modalLinks = document.getElementById("modalLinks");

    let all = [];

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function openModal(ch) {
      modalTitle.textContent = ch.title || "";
      modalMeta.innerHTML = `${escapeHtml(ch.category || "")} • ${escapeHtml(ch.points || 0)} pts • ID: <code>${escapeHtml(ch.id || "")}</code>`;
      modalPill.textContent = ch.difficulty || "";

      // Use briefing if present; otherwise fall back to prompt
      const briefingText = ch.briefing || ch.prompt || "";
      modalBrief.innerHTML = `<p>${escapeHtml(briefingText).replaceAll("\n", "<br/>")}</p>`;

      // Links area: only show downloads/urls if they exist
      const links = [];

      // Support either downloads[] or a single download string
      if (Array.isArray(ch.downloads) && ch.downloads.length) {
        ch.downloads.forEach(d => {
          if (d && d.url) {
            links.push(`<a class="link" href="${escapeHtml(d.url)}" target="_blank" rel="noopener">⬇ ${escapeHtml(d.label || "Download")}</a>`);
          }
        });
      } else if (ch.download) {
        links.push(`<a class="link" href="${escapeHtml(ch.download)}" target="_blank" rel="noopener">⬇ Download files</a>`);
      }

      if (ch.url) {
        links.push(`<a class="link" href="${escapeHtml(ch.url)}" target="_blank" rel="noopener">↗ Open resource</a>`);
      }

      // Optional: show hint inside modal
      if (ch.hint) {
        links.push(`<details class="hint"><summary>Hint</summary><p>${escapeHtml(ch.hint)}</p></details>`);
      }

      modalLinks.innerHTML = links.length ? links.join("<br/>") : `<div class="muted">No downloads needed — solve from the briefing.</div>`;

      // Open
      backdrop.classList.add("open");
      backdrop.setAttribute("aria-hidden", "false");

      // Focus for accessibility
      modalClose.focus();
    }

    function closeModal() {
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
    }

    // Close on backdrop click
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) closeModal();
    });
    modalClose.addEventListener("click", closeModal);
    modalDone.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && backdrop.classList.contains("open")) closeModal();
    });

    function render() {
      const q = search.value.toLowerCase().trim();
      const c = cat.value;

      const filtered = all.filter(x => {
        const hay = (x.title + " " + x.category + " " + (x.tags||[]).join(" ")).toLowerCase();
        return (!q || hay.includes(q)) && (!c || x.category === c);
      });

      grid.innerHTML = filtered.map((x, idx) => `
        <article class="card">
          <div class="row">
            <div>
              <div class="title">${escapeHtml(x.title)}</div>
              <div class="meta">${escapeHtml(x.category)} • ${escapeHtml(x.points)} pts • ID: <code>${escapeHtml(x.id)}</code></div>
            </div>
            <span class="pill">${escapeHtml(x.difficulty)}</span>
          </div>

          <p class="desc">${escapeHtml(x.prompt || "")}</p>

          <div class="actions">
            <button class="link link-btn" data-idx="${idx}">Briefing</button>
            <a class="link" href="YOUR_GOOGLE_FORM_LINK" target="_blank" rel="noopener">Submit Flag</a>
          </div>
        </article>
      `).join("");

      // Wire buttons
      document.querySelectorAll(".link-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-idx"));
          openModal(filtered[i]);
        });
      });
    }

    fetch("challenges.json")
      .then(r => r.json())
      .then(data => {
        all = data;
        const cats = [...new Set(all.map(x => x.category))].sort();
        cats.forEach(c => {
          const o = document.createElement("option");
          o.value = c; o.textContent = c;
          cat.appendChild(o);
        });
        render();
      });

    search.addEventListener("input", render);
    cat.addEventListener("change", render);
  </script>
</body>
</html>
